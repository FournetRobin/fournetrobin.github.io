<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Trouve pays</title>
  <style>
    body { margin:0; background:black; }
    h1, p, a { color:white; font-family: Arial, Helvetica, sans-serif; }
    a { color: darkorange; }
    #ui { position: absolute; z-index: 10; padding: 12px; }
  </style>
  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
</head>
<body>
  <div id="ui">
    <h1>Trouve-Pays : Quel pays voulez-vous afficher ?</h1>
    <input type="text" id="monpays" value="france" />
    <input type="button" value="Valider" onclick="runSearch()" />
    <a href="./ProjetCartoGeoQuizz.html">GeoQuizz</a>
    <p id="erreur"></p>
  </div>

  <script>
    const scene = new THREE.Scene();
    const texLoader = new THREE.TextureLoader();
    scene.background = texLoader.load('deepspace-scaled.jpg');

    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(2, 0, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const radius = 3;
    const geometry = new THREE.SphereGeometry(radius, 64, 64);
    const material = new THREE.MeshPhongMaterial({
      map: texLoader.load('8081_earthmap4k.jpg'),
      bumpMap: texLoader.load('8081_earthbump4k.jpg'),
      bumpScale: 0.25,
      specularMap: texLoader.load('8081_earthspec4k.jpg'),
      specular: new THREE.Color('grey')
    });

    const sphere = new THREE.Mesh(geometry, material);
    scene.add(sphere);

    const ambient = new THREE.AmbientLight(0x404040, 2.5);
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(5, 3, 5);
    scene.add(ambient, dir);

    function latlontexture(lat, lon, textureUrl) {
      const latRad = lat * Math.PI / 180;
      const lonRad = -lon * Math.PI / 180;
      const x = radius * Math.cos(latRad) * Math.cos(lonRad);
      const z = radius * Math.cos(latRad) * Math.sin(lonRad);
      const y = radius * Math.sin(latRad);

      const flagTex = texLoader.load(textureUrl);
      const boxGeo = new THREE.BoxGeometry(0.2, 0.2, 0.2);
      const boxMat = new THREE.MeshBasicMaterial({ map: flagTex });
      const cube = new THREE.Mesh(boxGeo, boxMat);
      cube.position.set(x, y, z);
      scene.add(cube);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function runSearch() {
      const pays = document.getElementById('monpays').value.trim();
      if (!pays) return;

      $.ajax({
        url: 'https://restcountries.com/v3.1/name/' + encodeURIComponent(pays) + '?fullText=true',
        type: 'GET',
        dataType: 'json',
        success: function (data) {
          document.getElementById("erreur").textContent = "";
          for (let i = 0; i < data.length; i++) {
            const lat = data[i].latlng?.[0];
            const lon = data[i].latlng?.[1];
            if (typeof lat !== 'number' || typeof lon !== 'number') continue;

            if (pays.toLowerCase() === "chad") {
              latlontexture(lat, lon, 'chad.jpg');
            } else if (pays.toLowerCase() === "brazil") {
              latlontexture(lat, lon, 'brasil.PNG');
            } else {
              const flag =
                (data[i].flags && (data[i].flags.png || data[i].flags.svg)) ||
                (data[i].flag && data[i].flag);
              latlontexture(lat, lon, flag);
            }
          }
        },
        error: function () {
          document.getElementById("erreur").textContent =
            "Oups... Le pays n'existe pas ou est mal orthographié. Écrivez le nom en anglais (ex: France → 'france').";
        }
      });
    }
  </script>
</body>
</html>
